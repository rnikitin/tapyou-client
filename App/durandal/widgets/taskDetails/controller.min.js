define(["require","exports","tasks/models/events","durandal/app","tasks/backend/signalR","tasks/backend/dal"],function(n,t,i,r,u,f){var e=i,o=r,s=u,h=f,c=function(){function n(n,t){this.settings={},this.model=ko.observable({Number:"",StateCode:0,persons:[],Address:"",TimePeriod:"",Station:null,Contact:"",Phones:[],Email:"",Note:"",Products:[],DeliveryPrice:0}),this.persons=ko.observableArray();var i=this;if(this.$container=$(n),$.extend(this.settings,t),!this.settings.id)throw new Error("id must be specified to load task details.");this.validate=_.bind(this.validatedText,this),this.load(),this.events(),o.trigger(e.map.taskSelected,this.settings.id)}return n.prototype.load=function(){var n=this;o.trigger(e.page.loading),s.tasksHub.server.getTask(this.settings.id).done(function(t){n.model(t)}).always(function(){o.trigger(e.page.loaded)}),h.getPersons().done(function(t){n.persons(t)})},n.prototype.events=function(){var n=this;o.on(e.tasks.changed,function(t){n.model()&&n.model().Id==t&&n.load()},this)},n.prototype.viewAttached=function(n){this.$view=$(n),this.$view.slideDown(),this.settings.target.slideUp(),o.trigger(e.tasks.widgets.detailsActivated,this)},n.prototype.editTask=function(n){o.trigger(e.tasks.startEdit,n.Id)},n.prototype.deleteTask=function(n){s.tasksHub.server.deleteTask(n.Id),o.trigger(e.tasks.deleted,n.Id),this.hide()},n.prototype.attachPerson=function(n){o.trigger(e.page.loading),s.tasksHub.server.attachPerson(this.model().Id,n.Id).always(function(){o.trigger(e.page.loaded)})},n.prototype.hide=function(){var n=this;this.settings.target.slideDown(),this.$container.slideUp(function(){n.$container.remove()}),o.trigger(e.map.deselect,this.settings.id)},n.prototype.validatedText=function(n,t){var i=!0;return n||(n="неизвестно",i=!1),_.contains(this.model().Errors,t)&&(i=!1),{text:n,isValid:i}},n.prototype.DateString=function(){return!this.model()||!this.model().From?"неизвестно":moment(this.model().From).local().format("L")},n.prototype.totalPrice=function(){var n=0;return this.model()&&(_.each(this.model().Products,function(t){n+=t.Price*t.Quantity}),n+=this.model().DeliveryPrice),n},n}();$.extend(ko.bindingHandlers,{validatedText:{init:function(n,t){var i=ko.utils.unwrapObservable(t());i.isValid||$(n).addClass("invalid"),$(n).text(i.text)},update:function(){}}}),t.model=c})